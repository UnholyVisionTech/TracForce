          {!dialClient&&sec==="settings"&&!selRole&&<div>
            <h1 style={{fontSize:22,fontWeight:700,margin:"0 0 18px",letterSpacing:-0.5}}>Settings</h1>
            <div style={{display:"flex",gap:0,marginBottom:18,borderBottom:"1px solid #eef0f2"}}>{[["general","General"],["display","Display"],["dialin","Dial-In"],["callrecords","Call Records"],...(canAssignKeys(role)?[["names","Profile Names"]]:[])].map(([k,l])=>(<button key={k} onClick={()=>setSettingsTab(k)} style={{padding:"10px 18px",border:"none",background:"none",fontSize:13,fontFamily:"inherit",color:settingsTab===k?"#1a1a2e":"#94a3b8",fontWeight:settingsTab===k?600:400,borderBottom:settingsTab===k?"2px solid #1a1a2e":"2px solid transparent",cursor:"pointer",marginBottom:-1}}>{l}</button>))}</div>
            {settingsTab==="general"&&<div style={{maxWidth:620}}><h3 style={{fontSize:15,fontWeight:600,margin:"0 0 14px"}}>Access Roles</h3><div style={{display:"flex",flexDirection:"column",gap:10}}>{ROLE_ORDER.map(r=>(<div key={r} onClick={()=>setSelRole(r)} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"14px 18px",borderRadius:12,border:"1px solid #eef0f2",background:"#fff",cursor:"pointer"}} onMouseEnter={e=>e.currentTarget.style.background="#fafbfc"} onMouseLeave={e=>e.currentTarget.style.background="#fff"}><div style={{display:"flex",alignItems:"center",gap:12}}><div style={{width:36,height:36,borderRadius:10,background:roleBg(r)+"18",display:"flex",alignItems:"center",justifyContent:"center",color:roleBg(r)}}><Ic t="paw" s={22}/></div><div><div style={{fontWeight:600,fontSize:14,color:roleBg(r)}}>{r}</div><div style={{fontSize:12,color:"#94a3b8",marginTop:1}}>{ROLE_INFO[r].desc.slice(0,55)}...</div></div></div><div style={{display:"flex",alignItems:"center",gap:8}}>{r!=="Client"&&<span style={{fontSize:12,color:"#94a3b8"}}>{team.filter(m=>m.role===r).length}</span>}{r!=="Client"&&<div style={{display:"flex",alignItems:"center",justifyContent:"center",width:28,height:28,borderRadius:6,background:roleBg(r)+"12",color:roleBg(r)}}><Ic t="key" s={14}/></div>}<Ic t="chev" s={14}/></div></div>))}</div></div>}
            {settingsTab==="display"&&<Card style={{padding:26,maxWidth:580}}><h3 style={{fontSize:15,fontWeight:600,margin:"0 0 14px"}}>Text Size</h3><p style={{fontSize:13,color:"#64748b",margin:"0 0 18px",lineHeight:1.5}}>Adjust the text size across the application. This does not affect the sidebar logo or branding.</p><div style={{display:"flex",alignItems:"center",gap:16,marginBottom:18}}><span style={{fontSize:12,color:"#94a3b8",fontWeight:500,whiteSpace:"nowrap"}}>A</span><input type="range" min={0.8} max={1.8} step={0.05} value={pendingTextSize} onChange={e=>setPendingTextSize(parseFloat(e.target.value))} style={{flex:1,accentColor:"#1a1a2e",cursor:"pointer"}}/><span style={{fontSize:18,color:"#94a3b8",fontWeight:500,whiteSpace:"nowrap"}}>A</span></div><div style={{display:"flex",gap:8,flexWrap:"wrap",marginBottom:18}}>{[{label:"X-Small",val:0.8},{label:"Small",val:0.9},{label:"Medium",val:1.1,def:true},{label:"Large",val:1.3},{label:"X-Large",val:1.5},{label:"XX-Large",val:1.8}].map(o=>(<button key={o.val} onClick={()=>setPendingTextSize(o.val)} style={{padding:"8px 16px",borderRadius:8,border:pendingTextSize===o.val?"2px solid #1a1a2e":"1px solid #e2e5ea",background:pendingTextSize===o.val?"#f0f2f5":"#fff",fontSize:12,fontWeight:pendingTextSize===o.val?600:400,color:pendingTextSize===o.val?"#1a1a2e":"#94a3b8",cursor:"pointer",fontFamily:"inherit"}}>{o.label}{o.def?" ✦":""}</button>))}</div><Card style={{padding:"16px 20px",background:"#fafbfc",marginBottom:18}}><div style={{fontSize:11*pendingTextSize,color:"#94a3b8",fontWeight:500,textTransform:"uppercase",letterSpacing:0.5,marginBottom:4}}>Preview</div><div style={{fontSize:14*pendingTextSize,fontWeight:500,color:"#374151",marginBottom:4}}>This is how your text will appear at the current size.</div><div style={{fontSize:12*pendingTextSize,color:"#64748b"}}>Smaller secondary text like dates, labels, and metadata will also scale accordingly.</div></Card><div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}><div style={{fontSize:12,color:"#94a3b8"}}>{pendingTextSize!==textSize?"Unsaved changes":textSize!==1.1?`Current: ${Math.round(textSize*100)}%`:"Default (Medium)"}</div><button onClick={()=>{setTextSize(pendingTextSize)}} disabled={pendingTextSize===textSize} style={{padding:"9px 24px",borderRadius:8,border:"none",background:pendingTextSize!==textSize?"#1a1a2e":"#e2e5ea",color:pendingTextSize!==textSize?"#fff":"#94a3b8",fontSize:13,fontWeight:600,cursor:pendingTextSize!==textSize?"pointer":"default",fontFamily:"inherit",transition:"all 0.15s"}}>Apply</button></div></Card>}
            {settingsTab==="dialin"&&<Card style={{padding:26,maxWidth:580}}><h3 style={{fontSize:15,fontWeight:600,margin:"0 0 14px"}}>Dial-In Configuration</h3><div style={{display:"flex",flexDirection:"column",gap:10}}>{[["own","Use Own Phone","Dial from your personal or company phone"],["tf","TracForce Dialer","Built-in VoIP dialing service"],["3rd","3rd Party Integration","Connect existing telephony provider"]].map(([k,l,d])=>(<label key={k} style={{display:"flex",alignItems:"flex-start",gap:12,padding:"13px 15px",borderRadius:10,border:dialMethod===k?"2px solid #1a1a2e":"1px solid #e2e5ea",cursor:"pointer",background:dialMethod===k?"#fafbfc":"#fff"}}><input type="radio" name="dial" checked={dialMethod===k} onChange={()=>setDialMethod(k)} style={{marginTop:2,accentColor:"#1a1a2e"}}/><div><div style={{fontWeight:500,fontSize:13.5}}>{l}</div><div style={{fontSize:12,color:"#94a3b8",marginTop:2}}>{d}</div></div></label>))}</div></Card>}
            {settingsTab==="callrecords"&&<Card style={{overflow:"hidden"}}><div style={{display:"grid",gridTemplateColumns:"1.5fr 1fr 1fr 1fr 1fr 80px",padding:"11px 22px",borderBottom:"1px solid #eef0f2",fontSize:10.5,textTransform:"uppercase",letterSpacing:0.8,color:"#94a3b8",fontWeight:600}}><span>Client</span><span>Date</span><span>Type</span><span>Duration</span><span>Agent</span><span>Rec</span></div>{clients.flatMap(cl=>(cls[cl.id]||[]).map(c2=>({...c2,cn:cl.name}))).sort((a,b)=>b.d.localeCompare(a.d)).map((c2,i)=>(<div key={i} style={{display:"grid",gridTemplateColumns:"1.5fr 1fr 1fr 1fr 1fr 80px",padding:"13px 22px",borderBottom:"1px solid #f5f6f8",alignItems:"center"}}><span style={{fontWeight:500,fontSize:13}}>{c2.cn}</span><span style={{fontSize:13}}>{c2.d}</span><span style={{fontSize:11,fontWeight:600,padding:"3px 10px",borderRadius:20,background:c2.ty==="Inbound"?"#f0fdf4":"#f0f4ff",color:c2.ty==="Inbound"?"#16a34a":"#3b5bdb",width:"fit-content"}}>{c2.ty}</span><span style={{fontSize:13,color:"#64748b"}}>{c2.dur}</span><span style={{fontSize:13}}>{c2.ag}</span><span>{c2.rc?<button style={{display:"flex",alignItems:"center",gap:4,padding:"4px 10px",borderRadius:6,border:"1px solid #e2e5ea",background:"#fff",fontSize:11,cursor:"pointer",fontFamily:"inherit",color:"#64748b"}}><Ic t="play" s={12}/>Play</button>:<span style={{color:"#cbd5e1",fontSize:11}}>—</span>}</span></div>))}</Card>}
            {settingsTab==="names"&&canAssignKeys(role)&&(()=>{const me=team.find(m=>m.role===role);return <Card style={{padding:26,maxWidth:580}}><h3 style={{fontSize:15,fontWeight:600,margin:"0 0 14px"}}>Edit Profile Names</h3><div style={{fontSize:12,color:"#64748b",marginBottom:6,lineHeight:1.5}}>Profile names are generated at account creation during first login. You may edit your own name and names of team members below your role level.</div><div style={{fontSize:12,color:"#94a3b8",marginBottom:16,lineHeight:1.5,display:"flex",alignItems:"center",gap:6}}><Ic t="key" s={12}/>Accounts can be created by roles with key access.</div><div style={{display:"flex",flexDirection:"column",gap:10}}>{team.map(m=>{const isSelf=me&&m.id===me.id;const canEdit=isSelf||isAbove(role,m.role);return(<div key={m.id} style={{display:"flex",alignItems:"center",gap:12,padding:"10px 14px",borderRadius:10,border:isSelf?"1px solid "+roleBg(role)+"40":"1px solid #eef0f2",background:isSelf?roleBg(role)+"06":"transparent",opacity:canEdit?1:0.55}}><Avatar src={m.photo} fallback={m.avatar} color={roleBg(m.role)+"30"} size={30}/>{canEdit?<input value={m.name} onChange={e=>{const v=e.target.value;setTeam(p=>p.map(x=>x.id===m.id?{...x,name:v}:x))}} style={{flex:1,border:"1px solid #e2e5ea",borderRadius:6,padding:"6px 10px",fontSize:13,fontFamily:"inherit",outline:"none"}}/>:<span style={{flex:1,fontSize:13,fontWeight:500,color:"#374151"}}>{m.name}</span>}<span style={{fontSize:11,color:canEdit?"#94a3b8":"#cbd5e1",fontWeight:500,flexShrink:0}}>{m.role}{isSelf?" (You)":""}</span>{!canEdit&&<span style={{color:roleBg(m.role)}}><Ic t="paw" s={14}/></span>}</div>)})}</div></Card>})()}
          </div>}

          {/* ROLE PROFILE */}
          {!dialClient&&sec==="settings"&&selRole&&<div>
            <Back label="Back to Settings" onClick={()=>setSelRole(null)}/>
            <Card style={{padding:28,marginBottom:20}}><div style={{display:"flex",alignItems:"center",gap:16,marginBottom:20}}><div style={{width:56,height:56,borderRadius:14,background:roleBg(selRole)+"18",display:"flex",alignItems:"center",justifyContent:"center",color:roleBg(selRole)}}><Ic t="paw" s={32}/></div><div><h2 style={{margin:0,fontSize:22,fontWeight:700,color:roleBg(selRole)}}>{selRole}</h2><div style={{fontSize:13,color:"#94a3b8",marginTop:3}}>{selRole==="Client"?"No platform access":team.filter(m=>m.role===selRole).length+" member"+(team.filter(m=>m.role===selRole).length!==1?"s":"")}</div></div></div><p style={{fontSize:14,lineHeight:1.7,color:"#374151",margin:"0 0 20px"}}>{ROLE_INFO[selRole].desc}</p><h4 style={{fontSize:13,fontWeight:600,margin:"0 0 10px",textTransform:"uppercase",letterSpacing:0.5,color:"#94a3b8"}}>Permissions</h4><div style={{display:"flex",flexDirection:"column",gap:6}}>{ROLE_INFO[selRole].perms.map((p2,i)=>(<div key={i} style={{display:"flex",alignItems:"center",gap:8,fontSize:13,color:"#374151"}}><Ic t="check" s={14}/>{p2}</div>))}</div></Card>
            {selRole!=="Client"&&<div><h3 style={{fontSize:15,fontWeight:600,margin:"0 0 14px"}}>Members with {selRole} access</h3>{!team.filter(m=>m.role===selRole).length&&<Card style={{textAlign:"center",padding:30,color:"#94a3b8",fontSize:13}}>No members.</Card>}<div style={{display:"flex",flexDirection:"column",gap:10}}>{team.filter(m=>m.role===selRole).map(m=>(<Card key={m.id} style={{padding:"16px 20px",display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer"}} onClick={()=>{setSec("team");setSelMember(m);setSelRole(null)}}><div style={{display:"flex",alignItems:"center",gap:14}}><Avatar src={m.photo} fallback={m.avatar} color={roleBg(m.role)+"30"} size={42}/><div><div style={{fontWeight:500,fontSize:14}}>{m.name}</div><div style={{fontSize:12,color:"#94a3b8"}}>{m.email}</div></div></div><div style={{display:"flex",gap:20,alignItems:"center"}}><div style={{textAlign:"center"}}><div style={{fontSize:16,fontWeight:700}}>{m.phoneTime}h</div><div style={{fontSize:10,color:"#94a3b8"}}>Phone</div></div><div style={{textAlign:"center"}}><div style={{fontSize:16,fontWeight:700}}>{m.noteCount}</div><div style={{fontSize:10,color:"#94a3b8"}}>Notes</div></div><div style={{textAlign:"center"}}><div style={{fontSize:16,fontWeight:700}}>{m.callCount}</div><div style={{fontSize:10,color:"#94a3b8"}}>Calls</div></div><Ic t="chev" s={14}/></div></Card>))}</div></div>}
          </div>}

          {/* AUDIT */}
          {!dialClient&&sec==="audit"&&(role==="Master"||role==="Admin")&&(()=>{const auditLogs=[];clients.forEach(c=>{(nts[c.id]||[]).forEach(n=>{auditLogs.push({t:n.d+(n.d.includes(" ")?"":" "+String(9+Math.abs((n.id*7)%14))+":"+String(10+(n.id*13)%50).padStart(2,"0")),u:n.a,a:"Added note to "+c.name,cat:"note"});});(cls[c.id]||[]).forEach(cl=>{auditLogs.push({t:cl.d+(cl.d.includes(" ")?"":" "+String(8+Math.abs((cl.id*11)%14))+":"+String(10+(cl.id*17)%50).padStart(2,"0")),u:cl.ag,a:"Completed "+cl.ty.toLowerCase()+" call to "+c.name+" ("+cl.dur+")",cat:"call"});});});auditLogs.push({t:"2026-02-25 14:32",u:"James K.",a:"Changed role of Chris D.",cat:"role"},{t:"2026-02-25 16:20",u:"James K.",a:"Updated billing — auto-renewal confirmed",cat:"billing"},{t:"2026-02-24 17:55",u:"Sarah M.",a:"Updated text size setting to Large",cat:"settings"},{t:"2026-02-23 15:10",u:"James K.",a:"Updated SSO integration settings",cat:"settings"},{t:"2026-02-22 16:50",u:"James K.",a:"Updated dial-in config",cat:"settings"},{t:"2026-02-26 09:12",u:"Sarah M.",a:"Logged in",cat:"auth"},{t:"2026-02-26 08:55",u:"James K.",a:"Logged in",cat:"auth"},{t:"2026-02-25 08:30",u:"Chris D.",a:"Logged in",cat:"auth"},{t:"2026-02-25 08:22",u:"Maya L.",a:"Logged in",cat:"auth"},{t:"2026-02-24 08:15",u:"Alex R.",a:"Logged in",cat:"auth"},{t:"2026-02-25 17:40",u:"Sarah M.",a:"Exported client list to CSV",cat:"data"},{t:"2026-02-20 10:30",u:"Alex R.",a:"Exported engagement report",cat:"data"});auditLogs.sort((a,b)=>b.t.localeCompare(a.t));const catBg={auth:"#f0f4ff",note:"#fefce8",call:"#f0fdf4",role:"#fdf2f8",settings:"#f5f3ff",billing:"#fff7ed",client:"#ecfeff",data:"#f0fdf4"};const catFg={auth:"#3b5bdb",note:"#a16207",call:"#16a34a",role:"#be185d",settings:"#7c3aed",billing:"#c2410c",client:"#0891b2",data:"#059669"};const recent=auditLogs.slice(0,50);const older=auditLogs.slice(50);const renderRow=(l,i)=>(<div key={i} style={{padding:"13px 22px",borderBottom:"1px solid #f5f6f8",display:"flex",alignItems:"center",gap:16}}><span style={{fontSize:12,color:"#94a3b8",whiteSpace:"nowrap",fontFamily:"monospace"}}>{l.t}</span><span style={{fontSize:11,fontWeight:600,padding:"3px 8px",borderRadius:6,whiteSpace:"nowrap",background:catBg[l.cat]||"#f5f6f8",color:catFg[l.cat]||"#64748b"}}>{l.cat.charAt(0).toUpperCase()+l.cat.slice(1)}</span><span style={{fontSize:12,fontWeight:600,color:"#3b5bdb",whiteSpace:"nowrap"}}>{l.u}</span><span style={{fontSize:13,color:"#374151",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{l.a}</span></div>);const activeTeam=team.filter(m=>m.role!=="Client"&&reportInclude.includes(m.id));const getDateRange=()=>{const now2=new Date(2026,1,25);if(reportRange==="custom")return{from:reportFrom,to:reportTo};const ranges={"7d":7,"30d":30,"3m":90,"6m":180,"12m":365,"all":9999};const days=ranges[reportRange]||365;const from=new Date(now2);from.setDate(from.getDate()-days);return{from:from.toISOString().slice(0,10),to:"2026-02-25"};};const dateRange=getDateRange();const filteredLogs=auditLogs.filter(l=>{const ld=l.t.slice(0,10);if(ld<dateRange.from||ld>dateRange.to)return false;const sn=l.u;return activeTeam.some(m=>{const short=m.name.split(" ")[0]+" "+m.name.split(" ")[1][0]+".";return short===sn;});});const getStats=(logs,member)=>{const sn=member?member.name.split(" ")[0]+" "+member.name.split(" ")[1][0]+".":null;const ml=member?logs.filter(l=>l.u===sn):logs;const notes=ml.filter(l=>l.cat==="note").length;const calls=ml.filter(l=>l.cat==="call").length;const other=ml.filter(l=>l.cat!=="note"&&l.cat!=="call").length;return{total:ml.length,notes,calls,other};};return <div>
            <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:18}}>
              <h1 style={{fontSize:22,fontWeight:700,margin:0,letterSpacing:-0.5}}>Audit Logs</h1>
              <div style={{display:"flex",alignItems:"center",gap:10}}>
                <span style={{fontSize:12,color:"#94a3b8"}}>Showing latest 50 of {auditLogs.length}</span>
                {older.length>0&&<button onClick={()=>setAuditModal(true)} style={{display:"flex",alignItems:"center",gap:5,padding:"6px 14px",borderRadius:8,border:"1px solid #e2e5ea",background:"#fff",fontSize:12,fontWeight:500,color:"#3b5bdb",cursor:"pointer",fontFamily:"inherit"}}><Ic t="clock" s={13}/>View All ({auditLogs.length})</button>}
                <button onClick={()=>exportAuditCSV(auditLogs)} style={{display:"flex",alignItems:"center",gap:5,padding:"6px 14px",borderRadius:8,border:"1px solid #e2e5ea",background:"#fff",fontSize:12,fontWeight:500,color:"#374151",cursor:"pointer",fontFamily:"inherit"}}><Ic t="download" s={13}/>Export CSV</button>
                <button onClick={()=>{setReportModal(true);setReportGenerated(false);setReportType("team");setReportExclude([]);setReportInclude(team.filter(m=>m.role!=="Client").map(m=>m.id));setRoleIndividual({});}} style={{display:"flex",alignItems:"center",gap:5,padding:"6px 14px",borderRadius:8,border:"none",background:"#1a1a2e",fontSize:12,fontWeight:500,color:"#fff",cursor:"pointer",fontFamily:"inherit"}}><Ic t="note" s={13}/>Generate Report</button>
              </div>
            </div>
            <Card style={{overflow:"hidden"}}>{recent.map(renderRow)}</Card>
            {auditModal&&<div style={{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:10000,display:"flex",alignItems:"center",justifyContent:"center"}}>
              <div onClick={()=>setAuditModal(false)} style={{position:"absolute",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.4)"}}/>
              <div style={{position:"relative",background:"#fff",borderRadius:16,width:"90%",maxWidth:820,maxHeight:"85vh",display:"flex",flexDirection:"column",boxShadow:"0 20px 60px rgba(0,0,0,0.2)"}}>
                <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"20px 26px 16px",borderBottom:"1px solid #eef0f2"}}>
                  <div><h2 style={{margin:0,fontSize:18,fontWeight:700}}>All Audit Logs</h2><span style={{fontSize:12,color:"#94a3b8"}}>{auditLogs.length} total entries</span></div>
                  <button onClick={()=>setAuditModal(false)} style={{width:32,height:32,borderRadius:8,border:"1px solid #e2e5ea",background:"#fff",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",fontSize:16,color:"#64748b"}}>✕</button>
                </div>
                <div style={{overflow:"auto",flex:1}}>{auditLogs.map(renderRow)}</div>
              </div>
            </div>}
            {reportModal&&!reportGenerated&&<div style={{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:10000,display:"flex",alignItems:"center",justifyContent:"center"}}>
              <div onClick={()=>setReportModal(false)} style={{position:"absolute",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.4)"}}/>
              <div style={{position:"relative",background:"#fff",borderRadius:16,width:"90%",maxWidth:680,maxHeight:"85vh",display:"flex",flexDirection:"column",boxShadow:"0 20px 60px rgba(0,0,0,0.2)"}}>
                <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"20px 26px 16px",borderBottom:"1px solid #eef0f2"}}>
                  <div><h2 style={{margin:0,fontSize:18,fontWeight:700}}>Generate Report</h2><span style={{fontSize:12,color:"#94a3b8"}}>Configure report options</span></div>
                  <button onClick={()=>setReportModal(false)} style={{width:32,height:32,borderRadius:8,border:"1px solid #e2e5ea",background:"#fff",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",fontSize:16,color:"#64748b"}}>✕</button>
                </div>
                <div style={{overflow:"visible",flex:1,padding:"20px 26px"}}>
                  <div style={{marginBottom:20}}>
                    <div style={{fontSize:13,fontWeight:600,marginBottom:10}}>Team Members</div>
                    <div style={{position:"relative"}}><button onClick={()=>setReportDrop(!reportDrop)} style={{width:"100%",padding:"10px 14px",borderRadius:10,border:"1px solid #e2e5ea",background:"#fff",cursor:"pointer",fontFamily:"inherit",textAlign:"left",display:"flex",alignItems:"center",justifyContent:"space-between"}}><span style={{fontSize:13,color:"#374151"}}>{(()=>{const allIds=team.filter(m=>m.role!=="Client").map(m=>m.id);const isAll=allIds.length===reportInclude.length&&allIds.every(id=>reportInclude.includes(id));return isAll?<span><span style={{fontWeight:600}}>All Team Members</span><span style={{color:"#94a3b8",marginLeft:6}}>({allIds.length})</span></span>:<span><span style={{fontWeight:600}}>{reportInclude.length} member{reportInclude.length!==1?"s":""} selected</span></span>})()}</span><span style={{fontSize:10,color:"#94a3b8",transform:reportDrop?"rotate(180deg)":"none",transition:"transform 0.15s"}}>▼</span></button>{reportDrop&&(()=>{const allIds=team.filter(m=>m.role!=="Client").map(m=>m.id);const isAll=allIds.length===reportInclude.length&&allIds.every(id=>reportInclude.includes(id));const roleList=["Master","Admin","Manager","Asst. Manager","Specialist"];return <div style={{position:"absolute",top:"100%",left:0,right:0,zIndex:10,marginTop:4,background:"#fff",borderRadius:10,border:"1px solid #e2e5ea",boxShadow:"0 8px 24px rgba(0,0,0,0.1)",maxHeight:420,overflow:"auto"}}><div style={{display:"flex",alignItems:"center",padding:"10px 14px",borderBottom:"1px solid #f5f6f8",gap:8,flexWrap:"wrap"}}><div onClick={()=>{setReportInclude(allIds);setRoleIndividual({});setReportExclude([]);}} style={{display:"flex",alignItems:"center",gap:6,cursor:"pointer",padding:"5px 10px",borderRadius:6,background:isAll?"#1a1a2e":"#f5f6f8",color:isAll?"#fff":"#64748b",fontSize:11,fontWeight:600,whiteSpace:"nowrap"}}>All</div>{roleList.map(r=>{const rm=team.filter(m=>m.role===r);if(!rm.length)return null;const allIn=rm.every(m=>reportInclude.includes(m.id));const anyIn=rm.some(m=>reportInclude.includes(m.id));return <div key={r} onClick={()=>{if(isAll){const justThisRole=rm.map(m=>m.id);setReportInclude(justThisRole);setRoleIndividual({});setReportExclude(allIds.filter(id=>!justThisRole.includes(id)));}else if(allIn){const without=reportInclude.filter(id=>!rm.some(m=>m.id===id));if(without.length===0){setReportInclude(allIds);setRoleIndividual({});setReportExclude([]);}else{setReportInclude(without);setRoleIndividual(p=>{const n={...p};delete n[r];return n;});setReportExclude(allIds.filter(id=>!without.includes(id)));}}else{const with_=[...new Set([...reportInclude,...rm.map(m=>m.id)])];setReportInclude(with_);setRoleIndividual(p=>{const n={...p};delete n[r];return n;});setReportExclude(allIds.filter(id=>!with_.includes(id)));}}} style={{display:"flex",alignItems:"center",gap:4,cursor:"pointer",padding:"5px 10px",borderRadius:6,background:allIn?roleBg(r)+"20":anyIn?roleBg(r)+"10":"#f5f6f8",color:allIn?roleBg(r):anyIn?roleBg(r):"#94a3b8",fontSize:11,fontWeight:600,whiteSpace:"nowrap",border:"1px solid "+(allIn?roleBg(r)+"40":anyIn?roleBg(r)+"20":"transparent")}}>{r}{allIn&&<span style={{fontSize:9}}>✓</span>}{anyIn&&!allIn&&<span style={{fontSize:9}}>◐</span>}</div>})}</div>{roleList.map(r=>{const rm=team.filter(m=>m.role===r);if(!rm.length)return null;return <div key={r}><div style={{padding:"6px 14px",background:"#fafbfc",borderBottom:"1px solid #f5f6f8",display:"flex",alignItems:"center",gap:6}}><span style={{width:8,height:8,borderRadius:"50%",background:roleBg(r)}}/><span style={{fontSize:10,fontWeight:700,color:"#64748b",textTransform:"uppercase",letterSpacing:0.5}}>{r}</span><span style={{fontSize:10,color:"#94a3b8"}}>({rm.filter(m=>reportInclude.includes(m.id)).length}/{rm.length})</span></div>{rm.map(m=>{const inc=reportInclude.includes(m.id);return <div key={m.id} onClick={()=>{if(isAll){setReportInclude([m.id]);setRoleIndividual({[r]:true});setReportExclude(allIds.filter(id=>id!==m.id));}else{const allInRole=rm.every(x=>reportInclude.includes(x.id));const hasIndiv=roleIndividual[r];if(allInRole&&!hasIndiv){const keep=reportInclude.filter(id=>!rm.some(x=>x.id===id));const next=[...keep,m.id];setReportInclude(next);setRoleIndividual(p=>({...p,[r]:true}));setReportExclude(allIds.filter(id=>!next.includes(id)));}else{let next;if(inc){next=reportInclude.filter(x=>x!==m.id);}else{next=[...reportInclude,m.id];}if(next.length===0){setReportInclude(allIds);setRoleIndividual({});setReportExclude([]);}else{setReportInclude(next);if(rm.every(x=>next.includes(x.id))){setRoleIndividual(p=>{const n={...p};delete n[r];return n;});}else if(rm.some(x=>next.includes(x.id))){setRoleIndividual(p=>({...p,[r]:true}));}else{setRoleIndividual(p=>{const n={...p};delete n[r];return n;});}setReportExclude(allIds.filter(id=>!next.includes(id)));}}}}} style={{display:"flex",alignItems:"center",gap:10,padding:"9px 14px",cursor:"pointer",borderBottom:"1px solid #f5f6f8",background:inc?roleBg(r)+"08":"transparent",transition:"background 0.1s"}} onMouseEnter={e=>{if(!inc)e.currentTarget.style.background="#fafbfc"}} onMouseLeave={e=>{if(!inc)e.currentTarget.style.background="transparent"}}><div style={{width:18,height:18,borderRadius:5,border:"2px solid "+(inc?roleBg(r):"#d1d5db"),background:inc?roleBg(r):"#fff",display:"flex",alignItems:"center",justifyContent:"center"}}>{inc&&<Ic t="check" s={10}/>}</div><Avatar src={m.photo} fallback={m.avatar} color={roleBg(m.role)+"30"} size={26}/><div style={{flex:1}}><div style={{fontWeight:inc?600:500,fontSize:12,color:inc?"#1a1a2e":"#64748b"}}>{m.name}</div><div style={{fontSize:10,color:"#94a3b8"}}>{m.role}</div></div></div>})}</div>})}</div>})()}</div>
                  </div>
                  <div style={{marginBottom:20}}>
                    <div style={{fontSize:13,fontWeight:600,marginBottom:10}}>Time Period</div>
                    <div style={{display:"flex",alignItems:"center",gap:0,borderRadius:8,border:"1px solid #e2e5ea",overflow:"hidden"}}>{[["7d","7D"],["30d","30D"],["3m","3M"],["6m","6M"],["12m","1Y"],["all","All"],["custom","Custom"]].map(([k,l],i,a)=>(<button key={k} onClick={()=>setReportRange(k)} style={{flex:1,padding:"7px 0",border:"none",borderRight:i<a.length-1?"1px solid #e2e5ea":"none",background:reportRange===k?"#1a1a2e":"#fff",cursor:"pointer",fontFamily:"inherit",fontSize:11,fontWeight:600,color:reportRange===k?"#fff":"#64748b",whiteSpace:"nowrap"}}>{l}</button>))}</div>
                    {reportRange==="custom"&&<div style={{display:"flex",alignItems:"center",gap:8,marginTop:10}}><input type="date" value={reportFrom} onChange={e=>setReportFrom(e.target.value)} style={{padding:"8px 12px",borderRadius:8,border:"1px solid #e2e5ea",fontSize:12,fontFamily:"inherit",color:"#374151"}}/><span style={{color:"#94a3b8",fontSize:12}}>to</span><input type="date" value={reportTo} onChange={e=>setReportTo(e.target.value)} style={{padding:"8px 12px",borderRadius:8,border:"1px solid #e2e5ea",fontSize:12,fontFamily:"inherit",color:"#374151"}}/></div>}
                  </div>
                  <button onClick={()=>{setReportDrop(false);setReportGenerated(true);}} disabled={activeTeam.length===0} style={{width:"100%",padding:"12px 0",borderRadius:10,border:"none",background:activeTeam.length>0?"#1a1a2e":"#e2e5ea",color:activeTeam.length>0?"#fff":"#94a3b8",fontSize:14,fontWeight:600,cursor:activeTeam.length>0?"pointer":"default",fontFamily:"inherit"}}>Generate Report ({activeTeam.length} member{activeTeam.length!==1?"s":""})</button>
                </div>
              </div>
            </div>}
            {reportModal&&reportGenerated&&(()=>{const dr=getDateRange();const fromD=new Date(dr.from+"T00:00:00");const toD=new Date(dr.to+"T00:00:00");const months=[];const cur=new Date(fromD.getFullYear(),fromD.getMonth(),1);const endM=new Date(toD.getFullYear(),toD.getMonth(),1);while(cur<=endM){months.push({key:cur.toISOString().slice(0,7),label:cur.toLocaleDateString("en-US",{month:"short",year:"numeric"})});cur.setMonth(cur.getMonth()+1);}const monthlyData=months.map(mo=>{const ml=filteredLogs.filter(l=>l.t.slice(0,7)===mo.key);const notes=ml.filter(l=>l.cat==="note").length;const calls=ml.filter(l=>l.cat==="call").length;const other=ml.filter(l=>l.cat!=="note"&&l.cat!=="call").length;return{...mo,notes,calls,other,total:notes+calls+other};});const maxMonth=Math.max(...monthlyData.map(m=>m.total),1);const ts=getStats(filteredLogs);const genDate=new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});const rangeStr=new Date(dr.from+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})+" – "+new Date(dr.to+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});return <div className="tf-report-print" style={{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:10000,background:"#f0f2f5",overflow:"auto"}}>
              <style>{`@media print{.tf-report-noprint{display:none!important}.tf-report-print{position:static!important;background:#fff!important;overflow:visible!important}.tf-report-page{box-shadow:none!important;margin:0!important;border-radius:0!important;max-width:none!important;break-inside:avoid}}`}</style>
              <div className="tf-report-noprint" style={{position:"sticky",top:0,zIndex:10,background:"#fff",borderBottom:"1px solid #eef0f2",padding:"12px 24px",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                <div style={{display:"flex",alignItems:"center",gap:12}}><button onClick={()=>{setReportGenerated(false);}} style={{display:"flex",alignItems:"center",gap:4,border:"1px solid #e2e5ea",background:"#fff",borderRadius:8,padding:"6px 14px",fontSize:12,color:"#64748b",cursor:"pointer",fontFamily:"inherit"}}><Ic t="chev" s={12}/>Back</button><span style={{fontSize:14,fontWeight:600}}>Audit Report Preview</span></div>
                <div style={{display:"flex",gap:8}}><button onClick={()=>window.print()} style={{display:"flex",alignItems:"center",gap:5,padding:"8px 20px",borderRadius:8,border:"none",background:"#1a1a2e",color:"#fff",fontSize:13,fontWeight:600,cursor:"pointer",fontFamily:"inherit"}}>Print / Save PDF</button><button onClick={()=>setReportModal(false)} style={{padding:"8px 16px",borderRadius:8,border:"1px solid #e2e5ea",background:"#fff",fontSize:13,color:"#64748b",cursor:"pointer",fontFamily:"inherit"}}>Close</button></div>
              </div>
              <div style={{padding:"32px 24px",display:"flex",flexDirection:"column",alignItems:"center",gap:32}}>
                <div className="tf-report-page" style={{background:"#fff",borderRadius:12,boxShadow:"0 2px 12px rgba(0,0,0,0.08)",maxWidth:780,width:"100%",padding:"48px 56px"}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:32,paddingBottom:24,borderBottom:"2px solid #1a1a2e"}}>
                    <div><div style={{fontSize:28,fontWeight:800,color:"#1a1a2e",letterSpacing:-1}}>TracForce</div><div style={{fontSize:11,color:"#94a3b8",textTransform:"uppercase",letterSpacing:2,marginTop:2}}>Audit Report</div></div>
                    <div style={{textAlign:"right"}}><div style={{fontSize:12,color:"#64748b"}}>{genDate}</div><div style={{fontSize:11,color:"#94a3b8",marginTop:2}}>{reportExclude.length===0?"Team-wide":"Individual"} · {activeTeam.length} member{activeTeam.length!==1?"s":""}</div><div style={{fontSize:11,color:"#64748b",marginTop:2,fontWeight:500}}>{rangeStr}</div>{reportExclude.length>0&&<div style={{fontSize:10,color:"#94a3b8",marginTop:2}}>{reportExclude.length} not included</div>}</div>
                  </div>
                  <div style={{fontSize:16,fontWeight:700,marginBottom:16}}>Summary</div>
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:16,marginBottom:32}}>{[["Total Activity",ts.total,"#1a1a2e"],["Notes",ts.notes,"#7c3aed"],["Calls",ts.calls,"#3b5bdb"],["Other",ts.other,"#64748b"]].map(([label,val,col],i)=>(<div key={i} style={{padding:"20px 16px",borderRadius:10,border:"1px solid #eef0f2",textAlign:"center"}}><div style={{fontSize:28,fontWeight:800,color:col}}>{val}</div><div style={{fontSize:11,color:"#94a3b8",marginTop:4,textTransform:"uppercase",letterSpacing:0.5}}>{label}</div></div>))}</div>
                  <div style={{fontSize:16,fontWeight:700,marginBottom:16}}>Activity Over Time</div>
                  <div style={{marginBottom:32}}>
                    <div style={{display:"flex",alignItems:"flex-end",gap:4,height:160,padding:"0 0 24px",borderBottom:"1px solid #eef0f2",position:"relative"}}>{monthlyData.map((mo,i)=>{const h=maxMonth>0?Math.round(mo.total/maxMonth*130):0;const nh=maxMonth>0?Math.round(mo.notes/maxMonth*130):0;const ch=maxMonth>0?Math.round(mo.calls/maxMonth*130):0;const oh=maxMonth>0?Math.round(mo.other/maxMonth*130):0;return <div key={i} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:0}}><div style={{display:"flex",flexDirection:"column",justifyContent:"flex-end",height:130,width:"100%",gap:1}}>{oh>0&&<div style={{height:oh,background:"#94a3b8",borderRadius:oh===h?"3px 3px 0 0":"0",width:"100%"}}/>}{ch>0&&<div style={{height:ch,background:"#3b5bdb",width:"100%"}}/>}{nh>0&&<div style={{height:nh,background:"#7c3aed",borderRadius:nh===h?"0":"0 0 3px 3px",width:"100%"}}/>}</div><div style={{fontSize:8,color:"#94a3b8",marginTop:6,whiteSpace:"nowrap",transform:"rotate(-45deg)",transformOrigin:"top center"}}>{mo.label}</div></div>})}</div>
                    <div style={{display:"flex",gap:16,justifyContent:"center",marginTop:20}}>{[["Notes","#7c3aed"],["Calls","#3b5bdb"],["Other","#94a3b8"]].map(([l,c])=>(<div key={l} style={{display:"flex",alignItems:"center",gap:5}}><div style={{width:10,height:10,borderRadius:2,background:c}}/><span style={{fontSize:11,color:"#64748b"}}>{l}</span></div>))}</div>
                  </div>
                  <div style={{fontSize:16,fontWeight:700,marginBottom:16}}>{reportExclude.length===0?"Team Member Breakdown":"Individual Reports"}</div>
                  {reportExclude.length===0&&<div>
                    <div style={{borderRadius:10,border:"1px solid #eef0f2",overflow:"hidden",marginBottom:24}}><div style={{display:"grid",gridTemplateColumns:"1.8fr 0.8fr 0.8fr 0.8fr 0.8fr",padding:"10px 16px",borderBottom:"1px solid #eef0f2",fontSize:9,textTransform:"uppercase",letterSpacing:1,color:"#94a3b8",fontWeight:700}}><span>Member</span><span style={{textAlign:"center"}}>Total</span><span style={{textAlign:"center"}}>Notes</span><span style={{textAlign:"center"}}>Calls</span><span style={{textAlign:"center"}}>Other</span></div>{activeTeam.map(m=>{const s=getStats(filteredLogs,m);const pct=ts.total>0?Math.round(s.total/ts.total*100):0;return <div key={m.id} style={{display:"grid",gridTemplateColumns:"1.8fr 0.8fr 0.8fr 0.8fr 0.8fr",padding:"11px 16px",borderBottom:"1px solid #f5f6f8",alignItems:"center"}}><div><div style={{fontWeight:600,fontSize:12}}>{m.name}</div><div style={{fontSize:10,color:"#94a3b8"}}>{m.role}</div></div><div style={{textAlign:"center"}}><span style={{fontWeight:700,fontSize:13}}>{s.total}</span><span style={{fontSize:9,color:"#94a3b8",marginLeft:3}}>{pct}%</span></div><div style={{textAlign:"center",fontSize:12,color:"#7c3aed",fontWeight:500}}>{s.notes}</div><div style={{textAlign:"center",fontSize:12,color:"#3b5bdb",fontWeight:500}}>{s.calls}</div><div style={{textAlign:"center",fontSize:12,color:"#64748b",fontWeight:500}}>{s.other}</div></div>})}</div>
                  </div>}
                  {reportExclude.length>0&&<div style={{display:"flex",flexDirection:"column",gap:20}}>
                    {activeTeam.map(m=>{const s=getStats(filteredLogs,m);const maxVal=Math.max(s.notes,s.calls,s.other,1);const mMonths=months.map(mo=>{const ml=filteredLogs.filter(l=>{const sn=m.name.split(" ")[0]+" "+m.name.split(" ")[1][0]+".";return l.u===sn&&l.t.slice(0,7)===mo.key;});return{...mo,total:ml.length};});const mMax=Math.max(...mMonths.map(x=>x.total),1);return <div key={m.id} style={{borderRadius:10,border:"1px solid #eef0f2",overflow:"hidden",breakInside:"avoid"}}>
                      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"14px 20px",borderBottom:"1px solid #f5f6f8",background:"#fafbfc"}}><div><div style={{fontWeight:700,fontSize:14}}>{m.name}</div><div style={{fontSize:11,color:"#94a3b8"}}>{m.role} · {m.email}</div></div><div style={{textAlign:"right"}}><span style={{fontSize:22,fontWeight:800,color:"#1a1a2e"}}>{s.total}</span><span style={{fontSize:10,color:"#94a3b8",marginLeft:4}}>actions</span></div></div>
                      <div style={{padding:"14px 20px"}}><div style={{display:"flex",gap:16,marginBottom:12}}>{[["Notes",s.notes,"#7c3aed"],["Calls",s.calls,"#3b5bdb"],["Other",s.other,"#94a3b8"]].map(([label,val,col])=>(<div key={label} style={{flex:1}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}><span style={{fontSize:10,color:"#64748b"}}>{label}</span><span style={{fontSize:11,fontWeight:700,color:col}}>{val}</span></div><div style={{height:5,borderRadius:3,background:"#f0f2f5"}}><div style={{height:"100%",borderRadius:3,background:col,width:Math.round(val/maxVal*100)+"%"}}/></div></div>))}</div><div style={{fontSize:10,color:"#94a3b8",marginBottom:6}}>Monthly Activity</div><div style={{display:"flex",alignItems:"flex-end",gap:2,height:36}}>{mMonths.map((mo,i)=>(<div key={i} style={{flex:1,background:"#3b5bdb",borderRadius:"2px 2px 0 0",height:Math.max(Math.round(mo.total/mMax*32),mo.total>0?2:0),opacity:mo.total>0?1:0.15}} title={mo.label+": "+mo.total}/>))}</div></div>
                    </div>})}
                  </div>}
                  <div style={{marginTop:32,paddingTop:20,borderTop:"1px solid #eef0f2",display:"flex",justifyContent:"space-between",alignItems:"center"}}><div style={{fontSize:10,color:"#94a3b8"}}>TracForce Audit Report · {rangeStr} · Generated {genDate}</div><div style={{fontSize:10,color:"#94a3b8"}}>{activeTeam.length} members · {filteredLogs.length} entries{reportExclude.length>0?" · "+reportExclude.length+" excluded":""}</div></div>
                </div>
              </div>
            </div>})()}
          </div>})()}

          {/* BILLING */}
          {!dialClient&&sec==="billing"&&role==="Master"&&<div><h1 style={{fontSize:22,fontWeight:700,margin:"0 0 18px"}}>Billing</h1><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16,marginBottom:20}}><Card style={{padding:"22px 26px"}}><div style={{fontSize:11.5,color:"#94a3b8",fontWeight:500,textTransform:"uppercase",letterSpacing:0.5}}>Current Plan</div><div style={{fontSize:24,fontWeight:700,margin:"8px 0 4px"}}>Enterprise</div><div style={{fontSize:13,color:"#64748b"}}>$299/month · 10 seats</div></Card><Card style={{padding:"22px 26px"}}><div style={{fontSize:11.5,color:"#94a3b8",fontWeight:500,textTransform:"uppercase",letterSpacing:0.5}}>Next Billing</div><div style={{fontSize:24,fontWeight:700,margin:"8px 0 4px"}}>Mar 1, 2026</div><div style={{fontSize:13,color:"#64748b"}}>Auto-renewal enabled</div></Card></div><Card style={{padding:"22px 26px"}}><h3 style={{fontSize:15,fontWeight:600,margin:"0 0 14px"}}>Payment History</h3>{[["Feb 1, 2026","$299.00","Paid"],["Jan 1, 2026","$299.00","Paid"],["Dec 1, 2025","$299.00","Paid"]].map(([d,a,s],i)=>(<div key={i} style={{display:"flex",justifyContent:"space-between",padding:"10px 0",borderBottom:i<2?"1px solid #f5f6f8":"none"}}><span style={{fontSize:13}}>{d}</span><span style={{fontSize:13,fontWeight:600}}>{a}</span><span style={{fontSize:11,fontWeight:600,padding:"3px 10px",borderRadius:20,background:"#f0fdf4",color:"#16a34a"}}>{s}</span></div>))}</Card></div>}
        </div>
      </div>

      {/* ASSIGN MODAL */}
      {assignModal&&<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.3)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100,backdropFilter:"blur(4px)"}} onClick={()=>setAssignModal(null)}><div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:16,padding:30,width:370,boxShadow:"0 20px 60px rgba(0,0,0,0.15)"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:18}}><h3 style={{margin:0,fontSize:17,fontWeight:700}}>Assign Key Access</h3><button onClick={()=>setAssignModal(null)} style={{background:"none",border:"none",cursor:"pointer",color:"#94a3b8",padding:4}}><Ic t="x" s={18}/></button></div><div style={{textAlign:"center",marginBottom:18}}><div style={{width:48,height:48,borderRadius:"50%",background:roleBg(assignModal.role)+"20",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 8px",fontSize:16,fontWeight:700,color:roleBg(assignModal.role)}}>{assignModal.avatar}</div><div style={{fontWeight:600,fontSize:15}}>{assignModal.name}</div><div style={{fontSize:12,color:"#94a3b8",marginTop:2}}>Current: <span style={{fontWeight:600,color:roleBg(assignModal.role)}}>{assignModal.role}</span></div></div><div style={{display:"flex",flexDirection:"column",gap:6}}>{assignableRoles(role).map(r=>(<button key={r} onClick={()=>handleRoleChange(assignModal.id,r)} style={{display:"flex",alignItems:"center",gap:10,padding:"11px 15px",borderRadius:10,border:"1px solid #e2e5ea",background:"#fff",cursor:"pointer",fontFamily:"inherit"}} onMouseEnter={e=>e.currentTarget.style.background="#fafbfc"} onMouseLeave={e=>e.currentTarget.style.background="#fff"}><span style={{width:10,height:10,borderRadius:"50%",background:roleBg(r)}}/><span style={{fontWeight:500,fontSize:13.5}}>{r}</span></button>))}</div></div></div>}

      {/* Appointment Modal */}
      {apptModal&&<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.3)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100,backdropFilter:"blur(4px)"}} onClick={()=>setApptModal(null)}><div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:16,padding:30,width:420,boxShadow:"0 20px 60px rgba(0,0,0,0.15)"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}><h3 style={{margin:0,fontSize:17,fontWeight:700}}>{apptModal.isNew?"Book Appointment":"Edit Appointment"}</h3><button onClick={()=>setApptModal(null)} style={{background:"none",border:"none",cursor:"pointer",color:"#94a3b8",padding:4}}><Ic t="x" s={18}/></button></div>
        {(()=>{const ac=apptModal.clientId?clients.find(x=>x.id===apptModal.clientId):null;return ac?<div style={{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",borderRadius:10,background:"#f8fafc",marginBottom:18}}><Avatar src={ac.photo} fallback={ini(ac.name)} size={32}/><div><div style={{fontWeight:600,fontSize:13.5}}>{ac.name}</div><div style={{fontSize:11.5,color:"#94a3b8"}}>{ac.co}</div></div>{apptModal.isNew&&<button onClick={()=>setApptModal(p=>({...p,clientId:null}))} style={{marginLeft:"auto",fontSize:11,color:"#94a3b8",background:"none",border:"none",cursor:"pointer",fontFamily:"inherit",textDecoration:"underline"}}>change</button>}</div>:<div style={{marginBottom:18}}><div style={{fontSize:10.5,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:6}}>Select Client</div><div style={{maxHeight:160,overflowY:"auto",border:"1px solid #e2e5ea",borderRadius:10}}>{clients.map(cl=>(<div key={cl.id} onClick={()=>setApptModal(p=>({...p,clientId:cl.id}))} style={{display:"flex",alignItems:"center",gap:10,padding:"8px 12px",cursor:"pointer",borderBottom:"1px solid #f5f6f8",transition:"background 0.1s"}} onMouseEnter={e=>e.currentTarget.style.background="#fafbfc"} onMouseLeave={e=>e.currentTarget.style.background="transparent"}><Avatar src={cl.photo} fallback={ini(cl.name)} size={26}/><div><div style={{fontSize:12.5,fontWeight:500}}>{cl.name}</div><div style={{fontSize:10.5,color:"#94a3b8"}}>{cl.co}</div></div></div>))}</div></div>;})()}
        <div style={{display:"flex",flexDirection:"column",gap:14}}>
          <div><div style={{fontSize:10.5,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:5}}>Type</div><div style={{display:"flex",flexWrap:"wrap",gap:6}}>{APPT_TYPES.map(t=>(<button key={t} onClick={()=>setApptModal(p=>({...p,type:t}))} style={{padding:"6px 12px",borderRadius:8,border:apptModal.type===t?"1px solid #3b5bdb":"1px solid #e2e5ea",background:apptModal.type===t?"#f0f4ff":"#fff",color:apptModal.type===t?"#3b5bdb":"#64748b",fontSize:12,fontWeight:apptModal.type===t?600:400,cursor:"pointer",fontFamily:"inherit"}}>{t}</button>))}</div></div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}><div><div style={{fontSize:10.5,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:5}}>Date</div><input type="date" value={apptModal.date} onChange={e=>setApptModal(p=>({...p,date:e.target.value}))} style={{width:"100%",padding:"8px 12px",borderRadius:8,border:"1px solid #e2e5ea",fontSize:13,fontFamily:"inherit",outline:"none"}}/></div><div><div style={{fontSize:10.5,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:5}}>Time</div><select value={apptModal.time} onChange={e=>setApptModal(p=>({...p,time:e.target.value}))} style={{width:"100%",padding:"8px 12px",borderRadius:8,border:"1px solid #e2e5ea",fontSize:13,fontFamily:"inherit",outline:"none",background:"#fff"}}>{["8:00 AM","8:30 AM","9:00 AM","9:30 AM","10:00 AM","10:30 AM","11:00 AM","11:30 AM","12:00 PM","12:30 PM","1:00 PM","1:30 PM","2:00 PM","2:30 PM","3:00 PM","3:30 PM","4:00 PM","4:30 PM","5:00 PM","5:30 PM","6:00 PM"].map(t=><option key={t} value={t}>{t}</option>)}</select></div></div>
          <div><div style={{fontSize:10.5,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:5}}>Notes</div><input value={apptModal.notes} onChange={e=>setApptModal(p=>({...p,notes:e.target.value}))} placeholder="Add notes for this appointment..." style={{width:"100%",padding:"8px 12px",borderRadius:8,border:"1px solid #e2e5ea",fontSize:13,fontFamily:"inherit",outline:"none"}}/></div>
          <div style={{display:"flex",gap:8,marginTop:4}}>{!apptModal.isNew&&<button onClick={()=>deleteAppointment(apptModal.id)} style={{padding:"10px 18px",borderRadius:8,border:"1px solid #fecaca",background:"#fef2f2",color:"#ef4444",fontSize:13,fontWeight:500,cursor:"pointer",fontFamily:"inherit"}}><Ic t="trash" s={14}/></button>}<button onClick={()=>setApptModal(null)} style={{flex:1,padding:"10px",borderRadius:8,border:"1px solid #e2e5ea",background:"#fff",fontSize:13,fontWeight:500,cursor:"pointer",fontFamily:"inherit",color:"#64748b"}}>Cancel</button><button disabled={!apptModal.clientId} onClick={()=>{const {isNew,...data}=apptModal;if(isNew)addAppointment(data);else updateAppointment(data);}} style={{flex:1,padding:"10px",borderRadius:8,border:"none",background:apptModal.clientId?"#1a1a2e":"#e2e5ea",color:apptModal.clientId?"#fff":"#94a3b8",fontSize:13,fontWeight:600,cursor:apptModal.clientId?"pointer":"default",fontFamily:"inherit"}}>{apptModal.isNew?"Book":"Save"}</button></div>
        </div>
      </div></div>}

      {newListModal&&<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.3)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100,backdropFilter:"blur(4px)"}} onClick={()=>setNewListModal(false)}><div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:16,padding:30,width:380,boxShadow:"0 20px 60px rgba(0,0,0,0.15)"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}><h3 style={{margin:0,fontSize:17,fontWeight:700}}>Create New List</h3><button onClick={()=>setNewListModal(false)} style={{background:"none",border:"none",cursor:"pointer",color:"#94a3b8",padding:4}}><Ic t="x" s={18}/></button></div><div style={{marginBottom:16}}><div style={{fontSize:10.5,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:5}}>List Name</div><input value={newListName} onChange={e=>setNewListName(e.target.value)} placeholder="e.g. VIP Clients, Referrals..." style={{width:"100%",padding:"10px 14px",borderRadius:8,border:"1px solid #e2e5ea",fontSize:13,fontFamily:"inherit",outline:"none",boxSizing:"border-box"}}/></div><div style={{marginBottom:20}}><div style={{fontSize:10.5,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:8}}>Color</div><div style={{display:"flex",gap:8}}>{["#3b5bdb","#7c3aed","#059669","#0891b2","#ef4444","#f59e0b","#ec4899","#1a1a2e"].map(c=>(<div key={c} onClick={()=>setNewListColor(c)} style={{width:32,height:32,borderRadius:8,background:c,cursor:"pointer",border:newListColor===c?"3px solid #fff":"3px solid transparent",boxShadow:newListColor===c?"0 0 0 2px "+c:"none",transition:"all 0.15s"}}/>))}</div></div><div style={{display:"flex",gap:8}}><button onClick={()=>setNewListModal(false)} style={{flex:1,padding:"10px",borderRadius:8,border:"1px solid #e2e5ea",background:"#fff",fontSize:13,fontWeight:500,cursor:"pointer",fontFamily:"inherit",color:"#64748b"}}>Cancel</button><button disabled={!newListName.trim()} onClick={()=>{const id="custom_"+Date.now();setCustomLists(p=>[...p,{id,name:newListName.trim(),color:newListColor}]);setNewListModal(false);setListFilter(id);}} style={{flex:1,padding:"10px",borderRadius:8,border:"none",background:newListName.trim()?"#1a1a2e":"#e2e5ea",color:newListName.trim()?"#fff":"#94a3b8",fontSize:13,fontWeight:600,cursor:newListName.trim()?"pointer":"default",fontFamily:"inherit"}}>Create List</button></div></div></div>}

      {/* ── Acquisition Entry Modal ── */}
      {aqModal&&<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.35)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100,backdropFilter:"blur(4px)"}} onClick={()=>setAqModal(false)}><div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:16,padding:30,width:580,maxHeight:"90vh",overflowY:"auto",boxShadow:"0 20px 60px rgba(0,0,0,0.18)"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:18}}><h3 style={{margin:0,fontSize:18,fontWeight:700}}>Add Acquisition Entry</h3><button onClick={()=>setAqModal(false)} style={{background:"none",border:"none",cursor:"pointer",color:"#94a3b8",padding:4}}><Ic t="x" s={18}/></button></div>
        <div style={{display:"flex",gap:4,marginBottom:18}}>{[["manual","Manual Entry"],["csv","Import CSV"]].map(([k,l])=><button key={k} onClick={()=>setAqTab(k)} style={{flex:1,padding:"9px",borderRadius:8,border:aqTab===k?"2px solid #3b5bdb":"1px solid #e2e5ea",background:aqTab===k?"#f0f4ff":"#fff",fontSize:12,fontWeight:aqTab===k?600:400,color:aqTab===k?"#3b5bdb":"#94a3b8",cursor:"pointer",fontFamily:"inherit"}}>{l}</button>)}</div>

        {aqTab==="manual"&&<div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:12}}>
              <div><div style={{fontSize:10,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:4}}>Source</div><input value={aqManual.source} onChange={e=>setAqManual(p=>({...p,source:e.target.value}))} placeholder="e.g. Google Ads, LinkedIn..." style={{width:"100%",padding:"9px 12px",borderRadius:8,border:"1px solid #e2e5ea",fontSize:13,fontFamily:"inherit",outline:"none",boxSizing:"border-box",background:"#fafbfc"}}/></div>
              <div><div style={{fontSize:10,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:4}}>Category</div><input value={aqManual.category} onChange={e=>setAqManual(p=>({...p,category:e.target.value}))} placeholder="e.g. Paid Search, Events..." style={{width:"100%",padding:"9px 12px",borderRadius:8,border:"1px solid #e2e5ea",fontSize:13,fontFamily:"inherit",outline:"none",boxSizing:"border-box",background:"#fafbfc"}}/></div>
            </div>
            <div style={{marginBottom:12}}><div style={{fontSize:10,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:4}}>Service / Description</div><input value={aqManual.service} onChange={e=>setAqManual(p=>({...p,service:e.target.value}))} placeholder="e.g. PPC Campaign — Enterprise" style={{width:"100%",padding:"9px 12px",borderRadius:8,border:"1px solid #e2e5ea",fontSize:13,fontFamily:"inherit",outline:"none",boxSizing:"border-box",background:"#fafbfc"}}/></div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12,marginBottom:16}}>
              <div><div style={{fontSize:10,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:4}}>Cost ($)</div><div style={{display:"flex",alignItems:"center",border:"1px solid #e2e5ea",borderRadius:8,background:"#fafbfc",overflow:"hidden"}}><span style={{fontSize:12,color:"#ef4444",fontWeight:700,padding:"9px 0 9px 12px"}}>$</span><input type="number" value={aqManual.cost} onChange={e=>setAqManual(p=>({...p,cost:e.target.value}))} placeholder="0" style={{flex:1,fontSize:13,fontWeight:600,color:"#ef4444",border:"none",outline:"none",background:"transparent",padding:"9px 12px 9px 4px",fontFamily:"inherit"}}/></div></div>
              <div><div style={{fontSize:10,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:4}}>Leads Generated</div><input type="number" value={aqManual.leads} onChange={e=>setAqManual(p=>({...p,leads:e.target.value}))} placeholder="0" style={{width:"100%",padding:"9px 12px",borderRadius:8,border:"1px solid #e2e5ea",fontSize:13,fontFamily:"inherit",outline:"none",boxSizing:"border-box",background:"#fafbfc"}}/></div>
              <div><div style={{fontSize:10,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:4}}>Date</div><input type="date" value={aqManual.d} onChange={e=>setAqManual(p=>({...p,d:e.target.value}))} style={{width:"100%",padding:"9px 12px",borderRadius:8,border:"1px solid #e2e5ea",fontSize:13,fontFamily:"inherit",outline:"none",boxSizing:"border-box",background:"#fafbfc"}}/></div>
            </div>
            <button onClick={()=>{const cost=Number(aqManual.cost)||0;const leads=Number(aqManual.leads)||0;if(!aqManual.source.trim())return;const nid=Date.now();setAqEntries(p=>[{id:nid,d:aqManual.d,source:aqManual.source.trim(),category:aqManual.category.trim()||"General",service:aqManual.service.trim(),cost,leads,cpl:leads>0?Math.round(cost/leads*100)/100:0,status:"active"},...p]);setAqHistory(p=>[{id:nid,ts:new Date().toISOString().slice(0,16).replace("T"," "),type:"manual",count:1,entries:[nid],label:"Manual — "+aqManual.source.trim()},...p]);setAqManual({source:"",category:"",service:"",cost:"",leads:"",d:new Date().toISOString().slice(0,10)});setAqModal(false);}} disabled={!aqManual.source.trim()} style={{width:"100%",padding:"11px",borderRadius:8,border:"none",background:aqManual.source.trim()?"#059669":"#e2e5ea",color:aqManual.source.trim()?"#fff":"#94a3b8",fontSize:13,fontWeight:600,cursor:aqManual.source.trim()?"pointer":"default",fontFamily:"inherit"}}>Add Entry</button>
          </div>}

        {aqTab==="csv"&&<div>
          <div style={{fontSize:12,color:"#64748b",marginBottom:8,lineHeight:1.5}}>Paste CSV data or click "Load Sample" to test. Format: <code style={{fontSize:11,background:"#f5f6f8",padding:"1px 5px",borderRadius:4}}>date,source,category,service,cost,leads</code></div>
          <textarea value={aqCsvText} onChange={e=>setAqCsvText(e.target.value)} rows={8} placeholder={"2026-02-20,Google Ads,Paid Search,PPC Campaign,4500,32\n2026-02-18,LinkedIn,Social Media,InMail Campaign,2800,18"} style={{width:"100%",border:"1px solid #e2e5ea",borderRadius:8,padding:"12px 14px",fontSize:12,fontFamily:"monospace",resize:"vertical",outline:"none",boxSizing:"border-box",background:"#fafbfc",marginBottom:12}}/>
          <div style={{display:"flex",gap:8}}>
            <button onClick={()=>setAqCsvText("2026-03-01,TikTok Ads,Social Media,Brand Awareness Campaign,3200,26\n2026-03-01,Google Display,Paid Display,Retargeting - Cart Abandoners,1800,15\n2026-02-28,Podcast Sponsor,Partnership,Tech Talk Weekly - 4 Episodes,5500,42\n2026-02-27,Cold Email,Direct,Outreach - Series A Startups,400,8\n2026-02-26,Bing Ads,Paid Search,Competitor Keywords Bid,950,11\n2026-02-25,Affiliate,Partnership,Partner Commission - Q1,2100,19")} style={{padding:"9px 16px",borderRadius:8,border:"1px solid #e2e5ea",background:"#fff",fontSize:12,fontWeight:500,cursor:"pointer",fontFamily:"inherit",color:"#374151"}}>Load Sample</button>
            <button onClick={()=>{if(!aqCsvText.trim())return;const rows=aqCsvText.trim().split("\n").map(r=>r.split(",").map(c=>c.trim()));const base=Date.now();const newEntries=rows.filter(r=>r.length>=5).map((r,i)=>{const cost=Number(r[4])||0;const leads=Number(r[5])||0;return {id:base+i,d:r[0]||new Date().toISOString().slice(0,10),source:r[1]||"Unknown",category:r[2]||"General",service:r[3]||"",cost,leads,cpl:leads>0?Math.round(cost/leads*100)/100:0,status:"active"};});if(newEntries.length){setAqEntries(p=>[...newEntries,...p]);setAqHistory(p=>[{id:base,ts:new Date().toISOString().slice(0,16).replace("T"," "),type:"csv",count:newEntries.length,entries:newEntries.map(e=>e.id),label:"CSV import — "+newEntries.length+" rows ("+[...new Set(newEntries.map(e=>e.source))].slice(0,3).join(", ")+(newEntries.length>3?" +more":"")+" )"},...p]);setAqModal(false);}}} disabled={!aqCsvText.trim()} style={{flex:1,padding:"9px",borderRadius:8,border:"none",background:aqCsvText.trim()?"#059669":"#e2e5ea",color:aqCsvText.trim()?"#fff":"#94a3b8",fontSize:12,fontWeight:600,cursor:aqCsvText.trim()?"pointer":"default",fontFamily:"inherit"}}>Import {aqCsvText.trim()?aqCsvText.trim().split("\n").filter(r=>r.trim()).length+" rows":"CSV"}</button>
          </div>
          {aqCsvText.trim()&&<div style={{marginTop:12,padding:12,borderRadius:8,background:"#f0fdf4",border:"1px solid #bbf7d0"}}><div style={{fontSize:11,fontWeight:600,color:"#059669",marginBottom:4}}>Preview ({aqCsvText.trim().split("\n").filter(r=>r.trim()).length} rows)</div>{aqCsvText.trim().split("\n").slice(0,4).map((r,i)=>{const c=r.split(",").map(x=>x.trim());return <div key={i} style={{fontSize:11,color:"#374151",padding:"3px 0",borderBottom:"1px solid #dcfce7"}}><strong>{c[1]||"?"}</strong> {" - "} {c[3]||"?"} {" · $"}{c[4]||0}{" · "}{c[5]||0}{" leads"}</div>;})}{aqCsvText.trim().split("\n").length>4&&<div style={{fontSize:10,color:"#94a3b8",marginTop:4}}>+{aqCsvText.trim().split("\n").length-4} more rows...</div>}</div>}
        </div>}
      </div></div>}

      {/* ── Acquisition History Modal ── */}
      {aqHistoryOpen&&<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.35)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100,backdropFilter:"blur(4px)"}} onClick={()=>setAqHistoryOpen(false)}><div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:16,padding:30,width:580,maxHeight:"85vh",overflowY:"auto",boxShadow:"0 20px 60px rgba(0,0,0,0.18)"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:18}}><div style={{display:"flex",alignItems:"center",gap:8}}><div style={{width:28,height:28,borderRadius:8,background:"#f0f4ff",display:"flex",alignItems:"center",justifyContent:"center",color:"#3b5bdb"}}><Ic t="clock" s={14}/></div><h3 style={{margin:0,fontSize:18,fontWeight:700}}>Import History</h3></div><button onClick={()=>setAqHistoryOpen(false)} style={{background:"none",border:"none",cursor:"pointer",color:"#94a3b8",padding:4}}><Ic t="x" s={18}/></button></div>
          <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:14}}>
            <div style={{fontSize:12,color:"#64748b"}}>{aqHistory.length} import{aqHistory.length!==1?"s":""} · {aqEntries.length} total entries</div>
            {aqEntries.length>0&&<button onClick={()=>{if(confirm("Delete ALL acquisition entries and history? This cannot be undone.")){setAqEntries([]);setAqHistory([]);}}} style={{display:"flex",alignItems:"center",gap:4,padding:"6px 12px",borderRadius:6,border:"1px solid #fecaca",background:"#fef2f2",fontSize:11,fontWeight:600,color:"#ef4444",cursor:"pointer",fontFamily:"inherit"}}><Ic t="trash" s={12}/>Clear All Data</button>}
          </div>
          {aqHistory.map(h=>{const hEntries=aqEntries.filter(e=>h.entries.includes(e.id));const hCost=hEntries.reduce((s,e)=>s+e.cost,0);const hLeads=hEntries.reduce((s,e)=>s+e.leads,0);const stillExists=hEntries.length;
          return <div key={h.id} style={{padding:"14px 16px",borderRadius:10,border:"1px solid #eef0f2",marginBottom:8,background:"#fafbfc"}}>
            <div style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:10}}>
              <div style={{flex:1}}>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:4}}>
                  <span style={{fontSize:10,fontWeight:600,padding:"2px 7px",borderRadius:6,background:h.type==="csv"?"#dbeafe":"#f0fdf4",color:h.type==="csv"?"#3b5bdb":"#059669"}}>{h.type==="csv"?"CSV":"Manual"}</span>
                  <span style={{fontSize:11,fontWeight:600}}>{h.count} entr{h.count!==1?"ies":"y"}</span>
                  {stillExists<h.count&&<span style={{fontSize:10,color:"#f59e0b"}}>({h.count-stillExists} deleted)</span>}
                </div>
                <div style={{fontSize:12,color:"#374151",marginBottom:3}}>{h.label}</div>
                <div style={{display:"flex",gap:12,fontSize:10,color:"#94a3b8"}}>
                  <span>{h.ts}</span>
                  {hCost>0&&<span>{"$"}{hCost.toLocaleString()} spent</span>}
                  {hLeads>0&&<span>{hLeads} leads</span>}
                </div>
              </div>
              <button onClick={()=>{setAqEntries(p=>p.filter(e=>!h.entries.includes(e.id)));setAqHistory(p=>p.map(x=>x.id===h.id?{...x,entries:[]}:x));}} disabled={!stillExists} style={{padding:"5px 10px",borderRadius:6,border:"1px solid "+(stillExists?"#fecaca":"#e2e5ea"),background:stillExists?"#fff":"#f5f6f8",fontSize:10,fontWeight:600,color:stillExists?"#ef4444":"#cbd5e1",cursor:stillExists?"pointer":"default",fontFamily:"inherit"}}><Ic t="trash" s={10}/> Delete</button>
            </div>
            {stillExists>0&&<div style={{marginTop:10,borderTop:"1px solid #eef0f2",paddingTop:8}}>{hEntries.slice(0,3).map(e=><div key={e.id} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 0",fontSize:11}}><span style={{color:"#374151"}}><strong>{e.source}</strong>{" — "}{e.service}</span><div style={{display:"flex",gap:10}}><span style={{color:"#ef4444",fontWeight:600}}>{"$"}{e.cost.toLocaleString()}</span><span style={{color:"#3b5bdb",fontWeight:600}}>{e.leads} leads</span></div></div>)}{stillExists>3&&<div style={{fontSize:10,color:"#94a3b8",marginTop:4}}>+{stillExists-3} more entries</div>}</div>}
          </div>;})}
          {!aqHistory.length&&<div style={{textAlign:"center",padding:30,color:"#94a3b8",fontSize:13}}>No import history yet.</div>}
      </div></div>}

      {/* ── Sale Modal ── */}
      {saleModal&&(()=>{
        const isEdit=!!saleModal.sale;
        const cId=saleModal.clientId;
        if(!saleModal.draft){const d=isEdit?{...saleModal.sale}:{id:Date.now(),d:new Date().toISOString().slice(0,10),amt:0,product:"",ag:team[0].name.split(" ")[0]+" "+team[0].name.split(" ")[1][0]+".",quality:"",saleType:"",netProfit:0,grossProfit:0,recurring:false,recurringFreq:"monthly",recurringAmt:0};setSaleModal({...saleModal,draft:d});return null;}
        const sd=saleModal.draft;
        const setSd=fn=>{const nv=typeof fn==="function"?fn(sd):{...sd,...fn};setSaleModal({...saleModal,draft:nv});};
        const Lbl=({children})=><div style={{fontSize:10,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,fontWeight:600,marginBottom:4}}>{children}</div>;
        const TxtF=({field,ph})=><input value={sd[field]||""} onChange={e=>setSd(p=>({...p,[field]:e.target.value}))} placeholder={ph} style={{width:"100%",padding:"9px 12px",borderRadius:8,border:"1px solid #e2e5ea",fontSize:13,fontFamily:"inherit",outline:"none",boxSizing:"border-box",background:"#fafbfc"}}/>;
        const NumF=({field,ph})=><div style={{display:"flex",alignItems:"center",border:"1px solid #e2e5ea",borderRadius:8,background:"#fafbfc",overflow:"hidden"}}><span style={{fontSize:12,color:"#059669",fontWeight:700,padding:"9px 0 9px 12px"}}>$</span><input type="number" value={sd[field]||""} onChange={e=>setSd(p=>({...p,[field]:Number(e.target.value)||0}))} placeholder={ph} style={{flex:1,fontSize:13,fontWeight:600,color:"#059669",border:"none",outline:"none",background:"transparent",padding:"9px 12px 9px 6px",fontFamily:"inherit"}}/></div>;
        const saveSale=()=>{const saleObj={...sd,recurring:sd.recurring||false,recurringFreq:sd.recurring?sd.recurringFreq:"",recurringAmt:sd.recurring?sd.recurringAmt:0};if(isEdit){setSales(p=>({...p,[cId]:(p[cId]||[]).map(x=>x.id===sd.id?saleObj:x)}));}else{setSales(p=>({...p,[cId]:[saleObj,...(p[cId]||[])]}));}setSaleModal(null);};
        const cl=clients.find(x=>x.id===cId);
        return <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.35)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100,backdropFilter:"blur(4px)"}} onClick={()=>setSaleModal(null)}><div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:16,padding:30,width:500,maxHeight:"90vh",overflowY:"auto",boxShadow:"0 20px 60px rgba(0,0,0,0.18)"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}><div><h3 style={{margin:0,fontSize:18,fontWeight:700}}>{isEdit?"Edit Sale":"New Sale"}</h3>{cl&&<div style={{fontSize:12,color:"#94a3b8",marginTop:2}}>{cl.name} · {cl.co}</div>}</div><button onClick={()=>setSaleModal(null)} style={{background:"none",border:"none",cursor:"pointer",color:"#94a3b8",padding:4}}><Ic t="x" s={18}/></button></div>

          <div style={{marginBottom:14}}><Lbl>Product / Service Name</Lbl><TxtF field="product" ph="e.g. Enterprise Plan, Consulting Package..."/></div>

          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:14}}>
            <div><Lbl>Sale Type</Lbl><TxtF field="saleType" ph="e.g. New Business, Upsell, Renewal..."/></div>
            <div><Lbl>Quality</Lbl><TxtF field="quality" ph="e.g. Premium, Standard, Basic..."/></div>
          </div>

          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12,marginBottom:14}}>
            <div><Lbl>Sale Amount</Lbl><NumF field="amt" ph="0"/></div>
            <div><Lbl>Expected Gross Profit</Lbl><NumF field="grossProfit" ph="0"/></div>
            <div><Lbl>Expected Net Profit</Lbl><NumF field="netProfit" ph="0"/></div>
          </div>

          <div style={{padding:"16px 18px",borderRadius:10,border:"1px solid "+(sd.recurring?"#3b5bdb30":"#e2e5ea"),background:sd.recurring?"#f0f4ff":"#fafbfc",marginBottom:20}}>
            <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:sd.recurring?14:0}}>
              <div style={{display:"flex",alignItems:"center",gap:8}}><Ic t="signal" s={15}/><div><div style={{fontSize:13,fontWeight:600}}>Recurring Billing</div><div style={{fontSize:11,color:"#64748b"}}>Subscribe client to automatic charges</div></div></div>
              <button onClick={()=>setSd(p=>({...p,recurring:!p.recurring}))} style={{width:44,height:24,borderRadius:12,border:"none",background:sd.recurring?"#3b5bdb":"#d1d5db",cursor:"pointer",position:"relative",transition:"background 0.2s"}}><div style={{width:20,height:20,borderRadius:10,background:"#fff",position:"absolute",top:2,left:sd.recurring?22:2,transition:"left 0.2s",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}}/></button>
            </div>
            {sd.recurring&&<div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
              <div><Lbl>Frequency</Lbl><div style={{display:"flex",gap:4}}>{["monthly","quarterly","annually"].map(f=><button key={f} onClick={()=>setSd(p=>({...p,recurringFreq:f}))} style={{flex:1,padding:"7px 0",borderRadius:6,border:sd.recurringFreq===f?"2px solid #3b5bdb":"1px solid #e2e5ea",background:sd.recurringFreq===f?"#f0f4ff":"#fff",fontSize:11,fontWeight:sd.recurringFreq===f?600:400,color:sd.recurringFreq===f?"#3b5bdb":"#94a3b8",cursor:"pointer",fontFamily:"inherit",textTransform:"capitalize"}}>{f}</button>)}</div></div>
              <div><Lbl>Recurring Amount</Lbl><NumF field="recurringAmt" ph="0"/></div>
            </div>}
          </div>

          <div style={{display:"flex",gap:10}}><button onClick={()=>setSaleModal(null)} style={{flex:1,padding:"11px",borderRadius:8,border:"1px solid #e2e5ea",background:"#fff",fontSize:13,fontWeight:500,cursor:"pointer",fontFamily:"inherit",color:"#64748b"}}>Cancel</button><button onClick={saveSale} disabled={!sd.product.trim()} style={{flex:2,padding:"11px",borderRadius:8,border:"none",background:sd.product.trim()?"#059669":"#e2e5ea",color:sd.product.trim()?"#fff":"#94a3b8",fontSize:13,fontWeight:600,cursor:sd.product.trim()?"pointer":"default",fontFamily:"inherit"}}>{isEdit?"Save Changes":"Add Sale"}</button></div>
        </div></div>;
      })()}
      <style>{`@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}} @keyframes grow{0%{width:0}100%{width:100%}}`}</style>
    </div>
  );
}

